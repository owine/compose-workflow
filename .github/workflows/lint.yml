name: Lint Docker Compose

on:
  workflow_call:
    inputs:
      stacks:
        description: "JSON array of stack names to lint"
        required: true
        type: string
      webhook-url:
        description: "1Password reference to Discord webhook URL"
        required: true
        type: string
      repo-name:
        description: "Repository display name for notifications"
        required: true
        type: string
      target-repository:
        description: "Target repository to checkout (owner/repo-name)"
        required: true
        type: string
      target-ref:
        description: "Git reference to checkout from target repository"
        required: false
        type: string
        default: 'main'

jobs:
  scanning:
    name: GitGuardian scan
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Load GitGuardian credentials
        id: op-load-secret
        uses: 1password/load-secrets-action@581a835fb51b8e7ec56b71cf2ffddd7e68bb25e0  # v2.0.0
        with:
          export-env: false
          unset-previous: true
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}
          GITGUARDIAN_API_KEY: "op://Docker/gitguardian/api_key"
      - name: Checkout target repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
        with:
          repository: ${{ inputs.target-repository }}
          ref: ${{ inputs.target-ref }}
          fetch-depth: 0  # fetch all history so multiple commits can be scanned
      - name: GitGuardian scan
        uses: GitGuardian/ggshield/actions/secret@cfb60b30abf1fd5f18a736220612c4b055a3932b  # v1.42.0
        env:
          GITHUB_PUSH_BEFORE_SHA: ${{ github.event.before }}
          GITHUB_PUSH_BASE_SHA: ${{ github.event.base }}
          GITHUB_PULL_BASE_SHA: ${{ github.event.pull_request.base.sha }}
          GITHUB_DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
          GITGUARDIAN_API_KEY: ${{ steps.op-load-secret.outputs.GITGUARDIAN_API_KEY }}

  lint:
    strategy:
      matrix:
        stack: ${{ fromJson(inputs.stacks) }}
      fail-fast: false
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: scanning
    steps:
      - name: Checkout target repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
        with:
          repository: ${{ inputs.target-repository }}
          ref: ${{ inputs.target-ref }}

      - name: YAML Linter
        run: yamllint --strict --config-file .yamllint ./${{ matrix.stack }}/compose.yaml

      - name: Docker Compose Linter
        run: docker compose -f ./${{ matrix.stack }}/compose.yaml config

      - name: Report lint status
        if: always()
        run: |
          echo "::group::Lint Results for ${{ matrix.stack }}"
          echo "Stack: ${{ matrix.stack }}"
          echo "Status: $([ ${{ job.status }} == 'success' ] && echo '‚úÖ PASSED' || echo '‚ùå FAILED')"
          echo "::endgroup::"

  notify:
    name: Discord Notification
    runs-on: ubuntu-latest
    needs: [scanning, lint]
    if: always()
    steps:
      - name: Load Discord webhook
        id: op-load-discord
        uses: 1password/load-secrets-action@581a835fb51b8e7ec56b71cf2ffddd7e68bb25e0  # v2.0.0
        with:
          export-env: false
          unset-previous: true
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}
          DISCORD_WEBHOOK: ${{ inputs.webhook-url }}

      - name: Send Discord notification
        uses: sarisia/actions-status-discord@5ddd3b114a98457dd80a39b2f00b6a998cd69008  # v1.15.3
        with:
          webhook: ${{ steps.op-load-discord.outputs.DISCORD_WEBHOOK }}
          status: ${{ needs.scanning.result == 'success' && needs.lint.result == 'success' && 'success' || 'failure' }}
          title: "üîç ${{ inputs.repo-name }} Lint Results"
          description: |
            **Repository:** `${{ inputs.target-repository }}`
            **Branch:** `${{ github.ref_name }}`
            **Commit:** `${{ github.sha }}`
            **Trigger:** ${{ github.event_name }}

            **Job Results:**
            ‚Ä¢ GitGuardian Scan: ${{ needs.scanning.result == 'success' && '‚úÖ PASSED' || '‚ùå FAILED' }}
            ‚Ä¢ Lint Jobs: ${{ needs.lint.result == 'success' && '‚úÖ PASSED' || '‚ùå FAILED' }}

            **Stacks Validated:** ${{ join(fromJson(inputs.stacks), ', ') }}
          color: ${{ needs.scanning.result == 'success' && needs.lint.result == 'success' && 0x00ff00 || 0xff0000 }}
          username: "GitHub Actions - ${{ inputs.repo-name }}"
          avatar_url: "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"