name: Lint Docker Compose

on:
  workflow_call:
    inputs:
      stacks:
        description: "JSON array of stack names to lint"
        required: true
        type: string
      webhook-url:
        description: "1Password reference to Discord webhook URL"
        required: true
        type: string
      repo-name:
        description: "Repository display name for notifications"
        required: true
        type: string
      target-repository:
        description: "Target repository to checkout (owner/repo-name)"
        required: true
        type: string
      target-ref:
        description: "Git reference to checkout from target repository"
        required: false
        type: string
        default: 'main'
      github-event-before:
        description: "GitHub event before SHA (github.event.before)"
        required: false
        type: string
        default: ''
      github-event-base:
        description: "GitHub event base SHA (github.event.base)"
        required: false
        type: string
        default: ''
      github-pull-base-sha:
        description: "GitHub pull request base SHA (github.event.pull_request.base.sha)"
        required: false
        type: string
        default: ''
      github-default-branch:
        description: "GitHub repository default branch (github.event.repository.default_branch)"
        required: false
        type: string
        default: 'main'
      event-name:
        description: "GitHub event name (github.event_name)"
        required: false
        type: string
        default: 'push'
      discord-user-id:
        description: "Discord user ID to mention in failure notifications (e.g., '<@123456789>')"
        required: false
        type: string
        default: ''

jobs:
  scanning:
    name: GitGuardian scan
    runs-on: ubuntu-24.04
    timeout-minutes: 10
    if: ${{ inputs.event-name == 'push' }}
    steps:
      - name: Checkout target repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2
        with:
          repository: ${{ inputs.target-repository }}
          ref: ${{ inputs.target-ref }}
          fetch-depth: 0  # fetch all history so multiple commits can be scanned

      - name: Display version information
        run: |
          echo "ğŸ“‹ Workflow Version Information"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Target repository: ${{ inputs.target-repository }}"
          echo "Target ref: ${{ inputs.target-ref }}"
          echo "Runner: ${{ runner.os }} ${{ runner.arch }}"
          echo ""
          echo "â„¹ï¸  Reusable workflow SHA shown in 'Uses:' line above"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Configure 1Password Service Account
        uses: 1password/load-secrets-action/configure@8d0d610af187e78a2772c2d18d627f4c52d3fbfb  # v3.1.0
        with:
          service-account-token: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}

      - name: Load GitGuardian credentials
        id: op-load-secret
        uses: 1password/load-secrets-action@8d0d610af187e78a2772c2d18d627f4c52d3fbfb  # v3.1.0
        with:
          unset-previous: true
        env:
          GITGUARDIAN_API_KEY: "op://Docker/gitguardian/api_key"

      - name: GitGuardian scan
        run: |
          echo ""
          echo "ğŸ”’ Starting GitGuardian security scanning..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""

      - name: Run GitGuardian scan
        uses: GitGuardian/ggshield-action@247ad4911092eee12989d379779c115632de6f84 # v1.47.0
        env:
          GITHUB_PUSH_BEFORE_SHA: ${{ inputs.github-event-before }}
          GITHUB_PUSH_BASE_SHA: ${{ inputs.github-event-base }}
          GITHUB_PULL_BASE_SHA: ${{ inputs.github-pull-base-sha }}
          GITHUB_DEFAULT_BRANCH: ${{ inputs.github-default-branch }}
          GITGUARDIAN_API_KEY: ${{ steps.op-load-secret.outputs.GITGUARDIAN_API_KEY }}

      - name: GitGuardian scan complete
        if: always()
        run: |
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          if [[ "${{ job.status }}" == "success" ]]; then
            echo "ğŸ‰ GITGUARDIAN SECURITY SCAN: PASSED"
            echo "   No secrets or security policy violations detected"
          else
            echo "ğŸ’¥ GITGUARDIAN SECURITY SCAN: FAILED"
            echo "   Security issues detected - review output above for details"
            echo "   Common issues: hardcoded secrets, API keys, passwords in code"
          fi
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Unload GitGuardian credentials
        uses: 1password/load-secrets-action@8d0d610af187e78a2772c2d18d627f4c52d3fbfb  # v3.1.0
        with:
          unset-previous: true

  actionlint:
    name: Workflow validation
    runs-on: ubuntu-24.04
    timeout-minutes: 5
    steps:
      - name: Checkout target repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2
        with:
          repository: ${{ inputs.target-repository }}
          ref: ${{ inputs.target-ref }}

      - name: Display version information
        run: |
          echo "ğŸ“‹ Workflow Version Information"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Target repository: ${{ inputs.target-repository }}"
          echo "Target ref: ${{ inputs.target-ref }}"
          echo "Runner: ${{ runner.os }} ${{ runner.arch }}"
          echo ""
          echo "â„¹ï¸  Reusable workflow SHA shown in 'Uses:' line above"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Run actionlint
        uses: raven-actions/actionlint@963d4779ef039e217e5d0e6fd73ce9ab7764e493 # v2.1.0

  lint:
    strategy:
      matrix:
        stack: ${{ fromJson(inputs.stacks) }}
      fail-fast: false
    runs-on: ubuntu-24.04
    timeout-minutes: 5
    steps:
      - name: Checkout target repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2
        with:
          repository: ${{ inputs.target-repository }}
          ref: ${{ inputs.target-ref }}

      - name: Checkout compose-workflow for linting scripts
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2
        with:
          repository: owine/compose-workflow
          ref: main
          path: .compose-workflow

      - name: Display version information
        run: |
          echo "ğŸ“‹ Workflow Version Information"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Reusable workflow: ${{ github.workflow_ref }}"
          echo "Target repository: ${{ inputs.target-repository }}"
          echo "Target ref: ${{ inputs.target-ref }}"
          echo "Stack: ${{ matrix.stack }}"
          echo "Runner: ${{ runner.os }} ${{ runner.arch }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Run stack validation
        run: |
          ./.compose-workflow/scripts/linting/validate-stack.sh \
            --stack "${{ matrix.stack }}" \
            --yamllint-config .yamllint

      - name: Report lint status
        if: always()
        run: |
          echo "ğŸ“Š Final Status for Stack: ${{ matrix.stack }}"
          echo ""
          if [[ "${{ job.status }}" == "success" ]]; then
            echo "ğŸ‰ STACK VALIDATION: PASSED"
            echo "   Stack '${{ matrix.stack }}' passed all validation checks"
            echo "   âœ… YAML linting (yamllint)"
            echo "   âœ… Docker Compose validation (docker compose config)"
          else
            echo "ğŸ’¥ STACK VALIDATION: FAILED"
            echo "   Stack '${{ matrix.stack }}' has validation issues"
            echo "   See detailed error output above for resolution steps"
          fi


  lint-summary:
    name: Lint Summary
    runs-on: ubuntu-24.04
    needs: [scanning, actionlint, lint]
    if: always()
    timeout-minutes: 5
    steps:
      - name: Checkout target repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2
        with:
          repository: ${{ inputs.target-repository }}
          ref: ${{ inputs.target-ref }}

      - name: Checkout compose-workflow for linting scripts
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2
        with:
          repository: owine/compose-workflow
          ref: main
          path: .compose-workflow

      - name: ğŸ“Š Generate detailed summary with error reproduction
        run: |
          ./.compose-workflow/scripts/linting/lint-summary.sh \
            --stacks '${{ inputs.stacks }}' \
            --yamllint-config .yamllint \
            --scanning-result "${{ needs.scanning.result }}" \
            --actionlint-result "${{ needs.actionlint.result }}" \
            --lint-result "${{ needs.lint.result }}"

  notify:
    name: Discord Notification
    runs-on: ubuntu-24.04
    needs: [scanning, actionlint, lint]
    if: always()
    steps:
      - name: Configure 1Password Service Account
        uses: 1password/load-secrets-action/configure@8d0d610af187e78a2772c2d18d627f4c52d3fbfb  # v3.1.0
        with:
          service-account-token: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}

      - name: Load Discord webhook and user ID
        id: op-load-discord
        uses: 1password/load-secrets-action@8d0d610af187e78a2772c2d18d627f4c52d3fbfb  # v3.1.0
        with:
          unset-previous: true
        env:
          DISCORD_WEBHOOK: ${{ inputs.webhook-url }}
          DISCORD_USER_ID: ${{ inputs.discord-user-id != '' && inputs.discord-user-id || 'SKIP' }}

      - name: Determine overall lint status
        id: lint-status
        run: |
          # Derive overall status from individual job results
          # Success requires: scanning passed/skipped AND actionlint passed AND lint passed
          SCANNING="${{ needs.scanning.result }}"
          ACTIONLINT="${{ needs.actionlint.result }}"
          LINT="${{ needs.lint.result }}"

          if [[ ("$SCANNING" == "success" || "$SCANNING" == "skipped") && "$ACTIONLINT" == "success" && "$LINT" == "success" ]]; then
            echo "result=success" >> "$GITHUB_OUTPUT"
          else
            echo "result=failure" >> "$GITHUB_OUTPUT"
          fi

      - name: Send Discord notification
        uses: sarisia/actions-status-discord@eb045afee445dc055c18d3d90bd0f244fd062708  # v1.16.0
        if: ${{ steps.lint-status.outputs.result == 'failure' || (steps.lint-status.outputs.result == 'success' && github.event_name != 'pull_request') }}
        with:
          webhook: ${{ steps.op-load-discord.outputs.DISCORD_WEBHOOK }}
          content: ${{ steps.lint-status.outputs.result != 'success' && inputs.discord-user-id != '' && steps.op-load-discord.outputs.DISCORD_USER_ID != 'SKIP' && format('<@{0}>', steps.op-load-discord.outputs.DISCORD_USER_ID) || '' }}
          status: ${{ steps.lint-status.outputs.result == 'success' && 'success' || 'failure' }}
          title: "ğŸ” ${{ inputs.repo-name }} â€¢ ${{ steps.lint-status.outputs.result == 'success' && 'Validation Passed' || 'Validation Failed' }}"
          description: |
            ${{ steps.lint-status.outputs.result == 'success' && 'âœ… **All validation checks passed**' || 'âŒ **Validation issues detected**' }}

            **ğŸ”’ Security Scan:** ${{ needs.scanning.result == 'success' && 'âœ… No secrets detected' || needs.scanning.result == 'skipped' && 'â­ï¸ Skipped (PR/manual)' || 'âŒ Issues found' }}
            **âš™ï¸ Workflow Validation:** ${{ needs.actionlint.result == 'success' && 'âœ… All workflows valid' || 'âŒ Issues detected' }}
            **ğŸ“‹ Code Quality:** ${{ needs.lint.result == 'success' && 'âœ… All stacks valid' || 'âŒ Issues detected' }}

            **ğŸ“‚ Validated Stacks:** `${{ join(fromJson(inputs.stacks), '`, `') }}`

            ${{ github.event_name == 'pull_request' && 'ğŸ”€ **Pull Request Validation**' || github.event_name == 'workflow_dispatch' && 'ğŸ”§ **Manual Validation**' || format('ğŸ“ **Push to `{0}`**', github.ref_name) }}

            ${{ needs.actionlint.result == 'failure' && '
            **âš™ï¸ Workflow Issues:**
            â€¢ GitHub Actions workflow validation failed
            â€¢ Review the **Workflow Validation** job for details
            â€¢ Fix workflow syntax, shellcheck, or expression errors
            â€¢ Test locally: `actionlint .github/workflows/*.yml`' || '' }}

            ${{ needs.lint.result == 'failure' && '
            **ğŸš¨ Action Required:**
            â€¢ Review stack validation errors in workflow logs
            â€¢ Fix YAML formatting and Docker Compose syntax
            â€¢ Test locally: `yamllint --strict stack/compose.yaml`
            â€¢ Check the **Lint Summary** job for detailed errors' || '' }}

            ${{ needs.scanning.result == 'failure' && '
            **ğŸ›¡ï¸ Security Alert:**
            â€¢ GitGuardian detected potential secrets
            â€¢ Review the **Security Scanning** job for details
            â€¢ Remove exposed secrets before proceeding
            â€¢ **This blocks deployment until resolved**' || '' }}

            ${{ steps.lint-status.outputs.result == 'success' && 'ğŸš€ **Ready for deployment**' || 'âš ï¸ **Deployment blocked until issues resolved**' }}
          color: ${{ steps.lint-status.outputs.result == 'success' && 0x28a745 || needs.scanning.result == 'failure' && 0xdc3545 || 0xfd7e14 }}
          username: "Compose Lint"
          avatar_url: "https://cdn-icons-png.flaticon.com/512/2103/2103633.png"

      - name: Unload Discord webhook
        uses: 1password/load-secrets-action@8d0d610af187e78a2772c2d18d627f4c52d3fbfb  # v3.1.0
        with:
          unset-previous: true
